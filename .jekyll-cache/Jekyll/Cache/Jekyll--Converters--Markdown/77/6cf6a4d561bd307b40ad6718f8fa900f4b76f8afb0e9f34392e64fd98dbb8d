I"—!<p>ì°¸ê³ ìë£Œ <br />
<a href="https://github.com/ll0301/architecture-samples/tree/todo-mvvm-live-kotlin">https://github.com/ll0301/architecture-samples/tree/todo-mvvm-live-kotlin</a></p>

<hr />
<hr />

<h2 id="script">Script</h2>
<blockquote>
  <p>Kotlin</p>
  <ul>
    <li>data
      <ul>
        <li>source
          <ul>
            <li>BookmarkRepository.kt</li>
            <li>remote
              <ul>
                <li>BookmarkRemoteDataSource.kt</li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
    <li>(mock)
      <ul>
        <li>Injection.kt</li>
      </ul>
    </li>
  </ul>
</blockquote>

<h2 id="datasourcebookmarkremotedatasourcekt">data/source/BookmarkRemoteDataSource.kt</h2>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>object BookmarkRemoteDataSource : BookmarkDataSource {

    private const val SERVICE_LATENCY_IN_MILLIS = 5000L

    private var BOOKMARKS_SERVICE_DATA = LinkedHashMap&lt;String, Bookmark&gt;(2)

    init {
        addBookmark("Google", "Portal","https://www.google.com")
        addBookmark("Naver", "Portal","https://www.naver.com")
        addBookmark("Daum", "Portal","https://www.daum.net")
    }

    private fun addBookmark(title: String, category: String, url: String) {

        val newBookmark = Bookmark(title, category, url)

        BOOKMARKS_SERVICE_DATA.put(newBookmark.id, newBookmark)
    }

    override fun getBookmarks(callback: BookmarkDataSource.LoadBookmarksCallback) {

        val bookmarks = Lists.newArrayList&lt;Bookmark&gt;(BOOKMARKS_SERVICE_DATA.values)

        // Simulate network
        Handler(Looper.getMainLooper()).postDelayed({
            callback.onBookmarksLoaded(bookmarks)
        }, SERVICE_LATENCY_IN_MILLIS)
    }

    override fun getBookmark(
        bookmarkId: String,
        callback: BookmarkDataSource.GetBookmarkCallback
    ) {

        val bookmark = BOOKMARKS_SERVICE_DATA[bookmarkId]

        // simulate network
        with(Handler(Looper.getMainLooper())) {
            if (bookmark != null) {
                postDelayed({ callback.onBookmarkLoaded(bookmark) }, SERVICE_LATENCY_IN_MILLIS)
            } else {
                postDelayed({ callback.onDataNotAvailable() }, SERVICE_LATENCY_IN_MILLIS)
            }
        }
    }

    override fun saveBookmark(bookmark: Bookmark) {

        BOOKMARKS_SERVICE_DATA.put(bookmark.id, bookmark)
    }

    override fun deleteAllBookmarks() {

        BOOKMARKS_SERVICE_DATA.clear()
    }

    override fun deleteBookmark(bookmarkId: String) {

        BOOKMARKS_SERVICE_DATA.remove(bookmarkId)
    }

    override fun refreshBookmark() {
        //
    }
}

</code></pre></div></div>
<p>-&gt; ì•„ì§ ì›ê²© ë°ì´í„°ë² ì´ìŠ¤ì™€ apiê°€ ì…‹íŒ…ë˜ì–´ìˆì§€ ì•Šê¸°ë•Œë¬¸ì— cacheë¥¼ í™œìš©í•˜ì—¬ ì„ì‹œë¡œ êµ¬í˜„</p>
<ul>
  <li>LinkedHashMap&lt;String, Bookmark&gt;
  -&gt; idì™€ bookmark ê°ì²´ë¥¼ crud <br />
  -&gt; remote database ê°€ êµ¬í˜„ì´ ì•ˆë˜ì–´ ìˆì–´ë„ linkedhashmapì„ í†µí•´ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥ <br />
  -&gt; linkedhasmapì€ cache ë©”ëª¨ë¦¬ ì´ë©° ì†ë„ê°€ ë¹ ë¦„ <br />
      -&gt; ë³€ë™ì´ ì—†ëŠ” ê²½ìš° cacheì—ì„œ ê°€ì ¸ì˜¤ëŠ” í¸ì´ ì†ë„ë‚˜ ì„±ëŠ¥ë©´ì—ì„œ ì´ë“ <br />
      -&gt; remote - cache ë¥¼ ë™ê¸°í™”í•´ì£¼ëŠ” ë¡œì§ì„ êµ¬í˜„í•´ì•¼í•¨</li>
  <li>init {} <br />
-&gt; init block ì´ë¼ í•˜ë©° ê°ì²´ ìƒì„±ì‹œ í˜¸ì¶œ ë¨ <br />
  -&gt; google, naver, daum ì´ë¼ëŠ” ì„ì‹œ ë°ì´í„° ëª¨ë¸ì´ ê°ì²´ ìƒì„± ì‹œ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì–´ linkedhasmapì— ì¶”ê°€ë¨</li>
  <li>BookmarkDataSource ìƒì† <br />
  -&gt; ë‚´ë¶€ ë©”ì†Œë“œê°€ ì˜¤ë²„ë¼ì´ë“œ ë˜ë©° ì„ì‹œ cache linkedmap ë¥¼ í†µí•´ crud ë™ì‘ êµ¬í˜„</li>
</ul>

<h2 id="datasourcebookmarkrepositorykt">data/source/BookmarkRepository.kt</h2>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class BookmarkRepository(
    private val bookmarkLocalDataSource: BookmarkDataSource,
    private val bookmarkRemoteDataSource: BookmarkDataSource
) : BookmarkDataSource {

    var cachedBookmarks: LinkedHashMap&lt;String, Bookmark&gt; = LinkedHashMap()

    var cacheIsDirty = false

    private fun refreshCache(bookmarks: List&lt;Bookmark&gt;) {
        cachedBookmarks.clear()
        bookmarks.forEach {
            cacheAndPerform(it) {}
        }
        cacheIsDirty = false
    }

    private fun refreshLocalDataSource(bookmarks: List&lt;Bookmark&gt;) {
        bookmarkLocalDataSource.deleteAllBookmarks()
        for (bookmark in bookmarks) {
            bookmarkLocalDataSource.saveBookmark(bookmark)
        }
    }

    private fun getBookmarkFromRemoteDataSource(callback: BookmarkDataSource.LoadBookmarksCallback) {
        bookmarkRemoteDataSource.getBookmarks(object : BookmarkDataSource.LoadBookmarksCallback {
            override fun onBookmarksLoaded(bookmarks: List&lt;Bookmark&gt;) {
                refreshCache(bookmarks)
                refreshLocalDataSource(bookmarks)

                callback.onBookmarksLoaded(ArrayList(cachedBookmarks.values))
            }

            override fun onDataNotAvailable() {
                callback.onDataNotAvailable()
            }

        })
    }

    private fun getBookmarkId(id: String) = cachedBookmarks[id]

    private inline fun cacheAndPerform(bookmark: Bookmark, perform: (Bookmark) -&gt; Unit) {
        val cachedBookmark =
            Bookmark(
                bookmark.id,
                bookmark.category,
                bookmark.url,
                bookmark.title
            ).apply {
                favicon = bookmark.favicon
                position = bookmark.position
            }

        cachedBookmarks[cachedBookmark.id] = cachedBookmark
        perform(cachedBookmark)
    }

		. . .
		BookmarkDataSource override method 
		. . .


    companion object {

        private var INSTANCE: BookmarkRepository? = null

        @JvmStatic
        fun getInstance(
            bookmarkLocalDataSource: BookmarkDataSource,
            bookmarkRemoteDataSource: BookmarkDataSource
        ) =
            INSTANCE ?: synchronized(BookmarkRepository::class.java) {
                INSTANCE ?: BookmarkRepository(
                    bookmarkLocalDataSource,
                    bookmarkRemoteDataSource
                ).also { INSTANCE = it }
            }

        @JvmStatic
        fun destroyInstance() {
            INSTANCE = null
        }
    }
}

</code></pre></div></div>
<ul>
  <li>BookmarkDataSource ë¥¼ 2ê°œ ì…ë ¥ë°›ì•„ remoteì™€ localë¡œ ë‚˜ëˆ”</li>
  <li>var cachedBookmarks: LinkedHashMap&lt;String, Bookmark&gt; = LinkedHashMap()
    <ul>
      <li>cacheì˜ ì‚¬ìš©ìœ¼ë¡œ ì†ë„ì™€ ì„±ëŠ¥ í–¥ìƒ</li>
    </ul>
  </li>
  <li>var cacheIsDirty = false</li>
  <li>Bookmark dataì— ë³€ë™ì´ìˆëŠ”ì§€ êµ¬ë¶„</li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>ë³€ë™ì´ì—†ìœ¼ë©´ false</td>
          <td>ë³€ë™ì´ ìˆìœ¼ë©´ true</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>refreshCache()
    <ul>
      <li>LinkedHashMap() ì„ refresh í•¨</li>
    </ul>
  </li>
  <li>refreshLocalDataSource()
    <ul>
      <li>Room Databaseì˜ bookmarks í…Œì´ë¸”ì„ refreshí•¨</li>
    </ul>
  </li>
  <li>getMookmarkRemoteDataSource()
    <ul>
      <li>localì—ëŠ” ì—†ìœ¼ë‚˜ remoteì— ê°ì²´ê°€ ì¡´ì¬í•  ë•Œ (ë™ê¸°í™”ê°€ ì•ˆëœ ìƒí™©)
        <ul>
          <li>cacheì™€ room databaseë¥¼ refresh í•˜ì—¬ ë™ê¸°í™”</li>
          <li>ê°€ì ¸ì˜¨ ê°ì²´ callbackìœ¼ë¡œ ë°˜í™˜</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>getBookmarkId() <br />
  -&gt; cacheì—ì„œ ì…ë ¥ë°›ì€ idì˜ bookmark ê°ì²´ ì°¾ì•„ ë°˜í™˜</li>
  <li>cacheAndPerform()
    <ul>
      <li>inline fun
        <ul>
          <li>Kotlinì€ ì»´íŒŒì¼ ë‹¨ê³„ì—ì„œ í•¨ìˆ˜ íƒ€ì…ì˜ ë³€ìˆ˜(ëŒë‹¤)ë¥¼ FunctionN ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•œ ê°ì²´ë¡œ ì €ì¥</li>
          <li>ë§¤ê°œë³€ìˆ˜ì— ë”°ë¼ Function0<R> , Function1&lt;P1, R&gt; ... Function22&lt;...&gt; ê¹Œì§€ ì œê³µë¨</R></li>
          <li>ê°ê°ì˜ ëŒë‹¤ì‹ë§ˆë‹¤ ê°ì²´ê°€ ìƒì„±ë˜ì–´ ë©”ëª¨ë¦¬ì— ì €ì¥ë˜ê³  invoke() í•¨ìˆ˜ê°€ ê°ê° í˜¸ì¶œë˜ì–´ ë©”ëª¨ë¦¬í• ë‹¹ ë° ê°€ìƒ í˜¸ì¶œì— ì˜í•œ ëŸ°íƒ€ì„ ì˜¤ë²„í—¤ë“œ ë°œìƒ</li>
          <li>ëŒë‹¤ë¥¼ ë§¤ê°œë¡œí•˜ëŠ” ê³ ì°¨í•¨ìˆ˜ë¥¼ inline fun ìœ¼ë¡œ ì •ì˜í•˜ì—¬ ì˜¤ë²„í—¤ë“œë¥¼ ì¤„ì„</li>
          <li>ì§ì ‘ ê°ì²´ë¥¼ í˜¸ì¶œí•˜ê¸° ë³´ë‹¨ í•¨ìˆ˜ì˜ ë³¸ë¬¸ì„ ë³µë¶™í•¨</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>(Bookmark) -&gt; Unit
    <ul>
      <li>í•¨ìˆ˜ì˜ ë°˜í™˜ êµ¬ë¬¸ì´ ì—†ë‹¤ëŠ” ê²ƒì„ í‘œí˜„í•˜ê¸° ìœ„í•´ ì‚¬ìš© = javaì˜ void</li>
    </ul>
  </li>
</ul>
:ET